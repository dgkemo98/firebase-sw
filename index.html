<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🎧 إشعارات DGKemo</title>
</head>
<body style="background:#000;color:#ffd700;font-family:Tahoma;text-align:center;padding:40px;">

  <h1>🎧 إشعارات DGKemo</h1>
  <p>اضغط على الزر لتفعيل الإشعارات وتنبيهك عند نزول أغنية جديدة 🔔</p>

  <button id="enableBtn" style="padding:10px 20px;background:#ffd700;border:none;color:#000;font-size:18px;border-radius:10px;cursor:pointer;">
    تفعيل الإشعارات
  </button>

  <div id="status" style="margin-top:20px;line-height:1.4;"></div>

  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBOyIGeCHOPAnBFYZ8wZZ2PYrfZXU9nIDU",
      authDomain: "dgkemo-52c93.firebaseapp.com",
      databaseURL: "https://dgkemo-52c93-default-rtdb.firebaseio.com",
      projectId: "dgkemo-52c93",
      storageBucket: "dgkemo-52c93.firebasestorage.app",
      messagingSenderId: "542241001900",
      appId: "1:542241001900:web:ab2de6b9a43a4322336a09",
      measurementId: "G-96BMQDSMXK"
    };
    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    const SW_URL = './firebase-messaging-sw.js';
    const statusEl = document.getElementById('status');
    const btn = document.getElementById('enableBtn');

    function showStatus(html, isError = false) {
      statusEl.innerHTML = html;
      statusEl.style.color = isError ? '#ff7070' : '#ffd700';
    }

    function escapeHtml(unsafe) {
      return String(unsafe).replace(/[&<>"'`=\/]/g, s =>
        ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;' }[s]));
    }

    btn.addEventListener('click', async () => {
      btn.disabled = true;
      showStatus('⏳ جارٍ التحقق...');

      try {
        if (!('serviceWorker' in navigator)) throw new Error('المتصفح لا يدعم Service Workers.');
        if (!('Notification' in window)) throw new Error('المتصفح لا يدعم Notifications.');

        const res = await fetch(SW_URL, { method: 'HEAD' });
        if (!res.ok) throw new Error(`ملف Service Worker غير موجود (${res.status}).`);

        const reg = await navigator.serviceWorker.register(SW_URL);
        messaging.useServiceWorker?.(reg);

        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          showStatus('⚠️ المستخدم رفض الإذن بالإشعارات.');
          btn.disabled = false;
          return;
        }

        // ✅ هنا المفتاح الصحيح بدون أي مسافات أو تاب
        const VAPID_KEY = "BOT23GIP27I7OV_g-iT_tcQlq6kpdz-Ew6UpaZvEiVIXBjbvre6Ma2xURI10Qs5GfF3RVQ7X1ZZfZWMs6kqrX0w";

        const token = await messaging.getToken({ vapidKey: VAPID_KEY });
        if (!token) throw new Error('لم يتم إنشاء token. تأكد أن الصفحة HTTPS.');

        showStatus(`✅ تم التفعيل بنجاح!<br><textarea style="width:100%;height:80px;">${escapeHtml(token)}</textarea>`);
        console.log('FCM Token:', token);

      } catch (err) {
        console.error(err);
        showStatus('❌ حدث خطأ أثناء التفعيل: ' + escapeHtml(err.message || err), true);
      } finally {
        btn.disabled = false;
      }
    });

    messaging.onMessage(payload => {
      console.log("📩 إشعار جديد:", payload);
      new Notification(payload.notification?.title || "🎵 إشعار جديد", {
        body: payload.notification?.body || "تم نشر أغنية جديدة!"
      });
    });
  </script>
</body>
</html>
