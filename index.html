<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ§ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª DGKemo</title>
</head>
<body style="background:#000;color:#ffd700;font-family:Tahoma;text-align:center;padding:40px;">

  <h1>ğŸ§ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª DGKemo</h1>
  <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØªÙ†Ø¨ÙŠÙ‡Ùƒ Ø¹Ù†Ø¯ Ù†Ø²ÙˆÙ„ Ø£ØºÙ†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© ğŸ””</p>

  <button id="enableBtn" style="padding:10px 20px;background:#ffd700;border:none;color:#000;font-size:18px;border-radius:10px;cursor:pointer;">
    ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  </button>

  <div id="status" style="margin-top:20px;line-height:1.4;"></div>

  <!-- Firebase compat libs -->
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging-compat.js"></script>

  <script>
    // === Ø¥Ø¹Ø¯Ø§Ø¯ Firebase - Ù„Ø§ ØªØºÙŠÙ‘Ø± Ù‡Ù†Ø§ Ø¥Ù„Ø§ Ù„Ùˆ ØªØ¹Ø±Ù Ø¨ØªØ¹Ù…Ù„ Ø¥ÙŠÙ‡ ===
    const firebaseConfig = {
      apiKey: "AIzaSyBOyIGeCHOPAnBFYZ8wZZ2PYrfZXU9nIDU",
      authDomain: "dgkemo-52c93.firebaseapp.com",
      databaseURL: "https://dgkemo-52c93-default-rtdb.firebaseio.com",
      projectId: "dgkemo-52c93",
      storageBucket: "dgkemo-52c93.firebasestorage.app",
      messagingSenderId: "542241001900",
      appId: "1:542241001900:web:ab2de6b9a43a4322336a09",
      measurementId: "G-96BMQDSMXK"
    };
    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    // Ù…ÙƒØ§Ù† Ù…Ù„Ù Ø§Ù„Ø®Ø¯Ù…Ø© (Ù„Ùˆ Ø±ÙØ¹ØªÙ‡ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ø³ØªØ®Ø¯Ù… './firebase-messaging-sw.js')
    const SW_URL = './firebase-messaging-sw.js'; // Ù„Ùˆ ØºÙŠØ±Øª Ø§Ø³Ù… Ø£Ùˆ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ø¹Ø¯Ù‘Ù„Ù‡ Ù‡Ù†Ø§

    const statusEl = document.getElementById('status');
    const btn = document.getElementById('enableBtn');

    function showStatus(html, isError=false) {
      statusEl.innerHTML = html;
      if(isError) statusEl.style.color = '#ff7070'; else statusEl.style.color = '#ffd700';
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…ÙØµÙ„Ø© Ù„Ù„Ù…Ø·ÙˆØ±
    function reportError(err) {
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', err);
      let msg = typeof err === 'string' ? err : (err && err.message) ? err.message : JSON.stringify(err);
      showStatus(`âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙØ¹ÙŠÙ„ â€” ${escapeHtml(msg)}<br><small>Ø§ÙØªØ­ Console (F12) ÙˆØ§Ù†Ø³Ø® Ø§Ù„Ø®Ø·Ø£ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¥Ù† Ø§Ø­ØªØ¬Øª Ù…Ø³Ø§Ø¹Ø¯Ø©.</small>`, true);
    }

    // Ø³Ù„Ø§Ù…Ø©: ØªÙ‡Ø±Ø¨ HTML Ù„Ø¹Ø±Ø¶Ù‡ Ø¢Ù…Ù†
    function escapeHtml(unsafe) {
      return String(unsafe).replace(/[&<>"'`=\/]/g, function (s) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s];
      });
    }

    btn.addEventListener('click', async function onEnable() {
      btn.disabled = true;
      showStatus('â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...');

      try {
        // 1) Ù‡Ù„ Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… service worker Ùˆ notificationsØŸ
        if (!('serviceWorker' in navigator)) throw new Error('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Service Workers.');
        if (!('Notification' in window)) throw new Error('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Notifications.');

        // 2) Ù†ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù Ø§Ù„Ù€ SW (HEAD request) Ù„Ù†Ø¹Ø·ÙŠ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆØ¶Ø­ Ù„Ùˆ 404
        try {
          const res = await fetch(SW_URL, { method: 'HEAD' });
          if (!res.ok) {
            throw new Error(`Ù…Ù„Ù Service Worker ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± "${SW_URL}" (HTTP ${res.status}). ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù…Ø±ÙÙˆØ¹ ÙˆØ¨Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§Ø±.`);
          }
        } catch (fetchErr) {
          throw new Error(`ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ù„Ù Service Worker. Ø§ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„ØªØ£ÙƒØ¯: ${location.origin}/${SW_URL.replace('./','')} â€” (ØªÙØ§ØµÙŠÙ„: ${fetchErr && fetchErr.message})`);
        }

        // 3) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù€ Service Worker
        let reg;
        try {
          reg = await navigator.serviceWorker.register(SW_URL);
          console.log('Service Worker registered:', reg);
          showStatus('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Service Worker Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†...');
        } catch (regErr) {
          throw new Error('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker: ' + (regErr && regErr.message || regErr));
        }

        // 4) Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù…Ø¹ Firebase Messaging (compat)
        try {
          if (typeof messaging.useServiceWorker === 'function') {
            messaging.useServiceWorker(reg);
          } else {
            console.warn('Ù…Ù„Ø§Ø­Ø¸Ø©: messaging.useServiceWorker ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ù‚Ø¯ ØªÙƒÙˆÙ† ØªØ³ØªØ®Ø¯Ù… Ø¥ØµØ¯Ø§Ø± Ù…Ø®ØªÙ„Ù Ù…Ù† Ù…ÙƒØªØ¨Ø§Øª Firebase.');
          }
        } catch (useErr) {
          console.warn('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… useServiceWorker:', useErr);
        }

        // 5) Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          showStatus('âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù† Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£Ùˆ Ù„Ù… ÙŠÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡.');
          btn.disabled = false;
          return;
        }

        // 6) Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ† â€” Ø¶Ø¹ Ù‡Ù†Ø§ Ù…ÙØªØ§Ø­ VAPID Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ø­Ø³Ø§Ø¨Ùƒ
        const VAPID_KEY = "BOT23GIP27I7OV_g-iT_tcQlq6kpdz-Ew6UpaZvEiVIXBjbvre6Ma2xURI10Qs5GfF3RVQ7X1ZZfZWMs6kqrX0w	"; // <-- Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§
        if (!VAPID_KEY || VAPID_KEY === "BOT23GIP27I7OV_g-iT_tcQlq6kpdz-Ew6UpaZvEiVIXBjbvre6Ma2xURI10Qs5GfF3RVQ7X1ZZfZWMs6kqrX0w	") {
          showStatus('âš ï¸ Ù„Ù… ØªØ¶Ù Ù…ÙØªØ§Ø­ VAPID Ø§Ù„Ø¹Ø§Ù…. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Firebase Console â†’ Cloud Messaging â†’ Web Push certificates ÙˆØ§Ù†Ø³Ø® Public VAPID key ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.', true);
          btn.disabled = false;
          return;
        }

        let token;
        try {
          token = await messaging.getToken({ vapidKey: VAPID_KEY });
        } catch (getTokenErr) {
          throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ token Ù…Ù† Firebase: ' + (getTokenErr && getTokenErr.message || getTokenErr));
        }

        if (!token) {
          throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ token. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙˆVAPID ØµØ­ÙŠØ­Ø© ÙˆØ£Ù† Ø§Ù„ØµÙØ­Ø© ØªØ¹Ù…Ù„ Ø¹Ø¨Ø± HTTPS.');
        }

        // 7) Ù†Ø¬Ø§Ø­ â€” Ø§Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ£Ø±Ø´Ø¯Ù‡ Ø£ÙŠÙ† ÙŠØ®Ø²Ù†
        showStatus('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!<br>Ø§Ù„ØªÙˆÙƒÙ†:<br><textarea style="width:100%;height:80px;">' + escapeHtml(token) + '</textarea><br><small>Ø§Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„ØªÙˆÙƒÙ† Ø£Ùˆ Ø®Ø²Ù‘Ù†Ù‡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©.</small>');
        console.log('FCM token:', token);

      } catch (err) {
        reportError(err);
      } finally {
        btn.disabled = false;
      }
    });

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    messaging.onMessage(function(payload) {
      console.log('Foreground message:', payload);
      try {
        const title = payload.notification?.title || 'Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯';
        const body = payload.notification?.body || '';
        new Notification(title, { body });
      } catch (e) {
        console.warn('ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ foreground:', e);
      }
    });
  </script>
</body>
</html>
